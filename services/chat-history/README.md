## 대화 내역 저장 기능

### 구현 개요

대화 내역을 AWS Cognito의 사용자 계정과 연동하여 저장하고, 재배포 시 삭제되도록 하는 기능을 구현했습니다. 핵심 구성 요소는 다음과 같습니다:

1. **DynamoDB 테이블**: 사용자별 채팅 세션과 메시지를 저장하는 두 개의 테이블
2. **Lambda API**: 대화 내역 관리를 위한 CRUD 작업을 처리하는 Lambda 함수
3. **API Gateway 엔드포인트**: 프론트엔드에서 대화 내역 API를 호출할 수 있는 RESTful 엔드포인트
4. **프론트엔드 연동**: 기존 대화 내역을 백엔드 API와 연동하는 새로운 스토어 및 서비스

### 주요 구성 파일

1. **`cloudformation/chat-db.yaml`**: 채팅 세션과 메시지를 저장할 DynamoDB 테이블 정의
2. **`cloudformation/chat-history.yaml`**: 채팅 내역 관리 Lambda 함수와 API Gateway 리소스 정의
3. **`services/chat-history/lambda_function.py`**: 채팅 내역 CRUD 작업을 처리하는 Lambda 함수 구현
4. **`frontend/src/services/chatApiService.ts`**: 백엔드 API와 통신하는 프론트엔드 서비스
5. **`frontend/src/stores/chatbotWithPersistence.ts`**: 대화 내역을 영구 저장하는 새로운 Pinia 스토어
6. **`frontend/src/helpers/initializeAuth.ts`**: 인증 및 대화 내역 초기화를 처리하는 헬퍼 함수
7. **`deploy-chat-history.sh`**: 대화 내역 저장 기능 배포를 위한 스크립트

### 핵심 기능 상세

1. **DynamoDB 테이블**
   - `WGA-ChatSessions-${Environment}`: 사용자별 채팅 세션 정보 저장
   - `WGA-ChatMessages-${Environment}`: 각 세션의 메시지 내역 저장
   - TTL 속성을 통해 오래된 데이터 자동 삭제 (기본값: 90일)

2. **Lambda 함수 기능**
   - 세션 생성, 조회, 수정, 삭제
   - 메시지 추가, 조회, 삭제
   - 사용자 ID 기반 권한 확인
   - CORS 지원

3. **프론트엔드 연동**
   - 기존 채팅 로직을 chatApiService를 통해 백엔드와 연동
   - 인증된 사용자에 대해 세션 및 메시지를 자동으로 불러오기
   - 타이핑 애니메이션 및 상태 유지를 위한 최적화

4. **재배포 시 삭제 처리**
   - DynamoDB 테이블에 TTL 속성 설정으로 데이터 자동 만료
   - CloudFormation 스택 삭제 시 DynamoDB 테이블도 함께 삭제됨

### AWS에서 수행할 구현 단계

1. **새 파일 생성**
   - 프로젝트 구조에 맞게 필요한 디렉토리 생성
   - 위에서 제공한 각 파일을 해당 위치에 저장

2. **ChatbotStore 교체**
   - 기존 `useChatbotStore` 대신 새로운 `chatbotWithPersistence` 스토어 사용
   - 필요한 컴포넌트에서 새 스토어로 import 변경

3. **CloudFormation 템플릿 배포**
   - `deploy-chat-history.sh` 스크립트를 실행하여 채팅 내역 기능 배포
   ```bash
   chmod +x deploy-chat-history.sh
   ./deploy-chat-history.sh [환경명]
   ```

4. **프론트엔드 빌드 및 배포**
   - 기존 배포 스크립트를 사용하여 수정된 프론트엔드 배포
   ```bash
   cd frontend
   npm install
   npm run build
   cd ..
   ./deploy.sh [환경명]
   ```

### 기능 테스트 방법

1. **대화 내역 저장 기능 테스트**
   - 로그인 후 채팅 페이지에서 메시지 전송
   - 브라우저 새로고침 후 대화 내역이 유지

2. **대화 내역 유지 테스트**
   - 로그아웃 후 다시 로그인
   - 이전 대화 내역이 그대로 표시되는지 확인
   
3. **세션 관리 테스트**
   - 여러 대화 세션 생성
   - 세션 간 전환하여 각 세션의 메시지가 올바르게 표시되는지 확인
   - 세션 삭제 기능 테스트

4. **사용자별 대화 내역 확인**
   - 다른 사용자 계정으로 로그인
   - 각 사용자별로 독립된 대화 내역이 관리되는지 확인

### 구현 시 중요한 고려사항

1. **권한 및 보안**
   - 각 사용자는 자신의 대화 내역만 접근 가능
   - DynamoDB 테이블에 대한 Lambda 함수의 권한은 최소 권한 원칙 적용
   - API Gateway 엔드포인트는 향후 Cognito 인증 적용 가능

2. **확장성 고려**
   - DynamoDB의 파티션 키와 정렬 키를 활용한 효율적인 데이터 접근
   - GSI(Global Secondary Index)를 통한 다양한 쿼리 패턴 지원
   - 사용자 및 메시지 증가에 따른 자동 스케일링

3. **비용 최적화**
   - 온디맨드 용량 모드를 통한 트래픽에 따른 비용 최적화
   - TTL을 통한 오래된 데이터 자동 정리로 스토리지 비용 절감
   - Lambda 함수의 타임아웃 및 메모리 설정 최적화

4. **에러 처리 및 로깅**
   - 모든 API 오류에 대한 적절한 상태 코드 및 메시지 반환
   - 중요 작업에 대한 로깅 구현
   - 프론트엔드에서의 효과적인 오류 처리 및 사용자 피드백

### 코드 수정 가이드

이미 작성한 코드를 기존 프로젝트에 통합하기 위해서는 다음 단계를 따르세요:

1. **파일 위치 확인**
   - 모든 새 파일이 적절한 디렉토리에 위치하는지 확인
   - CloudFormation 템플릿은 `cloudformation/` 디렉토리
   - Lambda 함수는 `services/chat-history/` 디렉토리
   - 프론트엔드 파일은 `frontend/src/` 내 해당 디렉토리

2. **의존성 확인**
   - Lambda 함수에서 사용하는 `cors_response` 함수가 `common/utils.py`에 있는지 확인
   - 프론트엔드 서비스에서 사용하는 `useAuthStore`가 올바르게 import 되는지 확인

3. **기존 코드와의 충돌 방지**
   - 새로운 파일 이름을 사용하여 기존 파일 덮어쓰기 방지
   - 필요한 경우 기존 코드를 백업

4. **점진적 배포 및 테스트**
   - 먼저 백엔드(DynamoDB 및 Lambda) 배포 후 테스트
   - 이후 프론트엔드 변경사항 적용
   - 각 단계별로 테스트하여 문제 발생 시 롤백 가능하도록 준비

### 추가 개선 가능 사항

1. **사용자 인터페이스 개선**
   - 대화 내역 목록에 더 많은 정보 표시 (메시지 수, 마지막 대화 시간 등)
   - 세션 관리 기능 강화 (이름 변경, 검색, 정렬 등)
   - 더 나은 로딩 및 피드백 UI

2. **기능 확장**
   - 메시지 내 이미지, 파일 첨부 기능
   - 대화 내역 내보내기/가져오기 기능
   - 대화 내역 분석 및 통계 기능

3. **성능 최적화**
   - 페이지네이션을 통한 대량의 메시지 처리
   - 메시지 캐싱 전략 구현
   - 실시간 업데이트를 위한 WebSocket 통합

4. **보안 강화**
   - Cognito 인증 강제화
   - 메시지 내용 암호화
   - API 속도 제한 구현

### 결론

이 구현을 통해 AWS 클라우드 환경에서 사용자별로 대화 내역을 저장하고 관리할 수 있는 서버리스 솔루션을 제공합니다. DynamoDB와 Lambda를 활용하여 확장성이 높고, 관리가 용이한 아키텍처를 구성했습니다. 프론트엔드와 백엔드의 효과적인 통합을 통해 사용자 경험을 향상시키면서도, 클라우드 네이티브 구성을 유지하여 프로젝트의 방향성을 지키고 있습니다.

구현된 코드는 기존 프로젝트와의 통합을 고려하여 작성되었으며, 필요에 따라 확장하거나 수정할 수 있는 유연한 구조를 가지고 있습니다. TTL 설정을 통해 오래된 데이터는 자동으로 정리되며, 재배포 시 CloudFormation 스택 삭제를 통해 모든 리소스가 함께 삭제됩니다.

이 구현을 통해 채팅 서비스의 사용자 경험이 크게 향상되고, 중요한 대화 내용이 안전하게 저장되어 사용자가 필요할 때 언제든지 접근할 수 있게 됩니다.